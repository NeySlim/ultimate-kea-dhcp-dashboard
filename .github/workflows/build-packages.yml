name: Build Distribution Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-deb:
    name: Build Debian/Ubuntu Package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debhelper devscripts build-essential
      
      - name: Prepare source directory
        run: |
          VERSION=$(cat VERSION)
          mkdir -p /tmp/build/ultimate-kea-dashboard-${VERSION}
          cp -r * /tmp/build/ultimate-kea-dashboard-${VERSION}/ || true
          cp -r packaging/debian /tmp/build/ultimate-kea-dashboard-${VERSION}/
      
      - name: Build DEB package
        run: |
          VERSION=$(cat VERSION)
          cd /tmp/build/ultimate-kea-dashboard-${VERSION}
          dpkg-buildpackage -us -uc -b
          # Move built package to workspace
          mv /tmp/build/*.deb $GITHUB_WORKSPACE/
      
      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: "*.deb"

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    container: fedora:latest
    
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y rpm-build rpmdevtools tar gzip
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree
      
      - name: Prepare source tarball
        run: |
          VERSION=$(cat VERSION)
          mkdir -p ultimate-kea-dashboard-${VERSION}
          cp -r bin lib static data etc start.sh requirements.txt VERSION \
                ultimate-kea-dashboard-${VERSION}/
          tar czf ~/rpmbuild/SOURCES/ultimate-kea-dashboard-${VERSION}.tar.gz \
                  ultimate-kea-dashboard-${VERSION}
          cp packaging/rpm/ultimate-kea-dashboard.spec ~/rpmbuild/SPECS/
      
      - name: Build RPM package
        run: |
          cd ~/rpmbuild/SPECS
          rpmbuild -bb ultimate-kea-dashboard.spec
          # Move built package to workspace
          cp ~/rpmbuild/RPMS/noarch/*.rpm $GITHUB_WORKSPACE/
      
      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: "*.rpm"

  build-arch:
    name: Build Arch Linux Package
    runs-on: ubuntu-latest
    container: archlinux:latest
    
    steps:
      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm base-devel git
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create build user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
      
      - name: Prepare source tarball
        run: |
          VERSION=$(cat VERSION)
          mkdir -p ultimate-kea-dashboard-${VERSION}
          cp -r bin lib static data etc start.sh requirements.txt VERSION \
                ultimate-kea-dashboard-${VERSION}/
          tar czf ultimate-kea-dashboard-${VERSION}.tar.gz \
                  ultimate-kea-dashboard-${VERSION}
          cp packaging/arch/PKGBUILD .
          cp packaging/arch/ultimate-kea-dashboard.install .
          chown -R builder:builder .
      
      - name: Build Arch package
        run: |
          su - builder -c "cd ${GITHUB_WORKSPACE} && makepkg -s --noconfirm"
          # Ensure proper permissions
          chown root:root *.pkg.tar.zst
      
      - name: Upload Arch artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: "*.pkg.tar.zst"

  create-release:
    name: Create GitHub Release
    needs: [build-deb, build-rpm, build-arch]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create installer
        run: |
          bash create-installer.sh
      
      - name: Get version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT
      
      - name: Extract changelog
        id: changelog
        run: |
          VERSION=$(cat VERSION)
          awk "/^## \[${VERSION}\]/,/^## \[/" CHANGELOG.md | \
          sed '/^## \[/d' | sed '/^$/d' > release_notes.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          body_file: release_notes.md
          files: |
            ultimate-kea-dashboard-installer.sh
            artifacts/deb-package/*.deb
            artifacts/rpm-package/*.rpm
            artifacts/arch-package/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
